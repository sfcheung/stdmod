---
title: "Numerical Example - stdmod_lavaan"
author: "Shu Fai Cheung"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Numerical Example - stdmod_lavaan}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width  = 6, 
  fig.height = 6
)
options(width = 132)
```

# Setup the Environment

```{r setup}
library(stdmod) # For computing Standardized Moderation Effect Conveniently
library(lavaan) # For doing path analysis in lavaan.
```

# Load the Dataset

```{r load_dataset}
data(sleep_emo_con)
head(sleep_emo_con)
```

This data set has 500 cases of data. The variables are sleep duration, age, gender,  and the scores from two personality scales, emotional stability and conscientiousness of the IPIP Big Five markers. Please refer to xxx for the detail of the data set.


# Compute the product term

Since the product term cannot be automatically generate through the function in 
SEM (The way of simply using variable A*variable B to specify the product term will 
not work in SEM), we need to compute the product term manually.

```{r pro_term}
sleep_emo_con$emo_con <- 
  sleep_emo_con$emotional_stability * sleep_emo_con$conscientiousness
```

# Specify the model in SEM and 

After computing the product of the model in SEM, the remaining process is just following the normal procedures of constructing SEM in R. 
We specify the model itself by using age, gender, emotional stability, conscientiousness and the product term of emotional stability and conscientiousness to predict the sleep duration. Therefore, we conduct the a SEM with a moderator as follow: 

```{r mod_sem}
mod <- 
"
sleep_duration ~ age + gender + emotional_stability + conscientiousness + emo_con
"

fit <- sem(mod, sleep_emo_con, likelihood = "wishart")
# likelihood = "wishart" is used to reproduce results 
# in OLS regression. Users do not have to use this option.

summary(fit)
```

* The argument "Likelihood = wishart" is provided because it ensure the results of the SEM to be consistent on each trial, users are not required to type in this argument when they are conducting normal OLS regression.

# Standardize and mean-center all variables

The argument to_center tells std_selected which variables need to be mean centered. 

The argument to_scale tells std_selected which variables need to be rescaled by their standard deviation after centering.

If we want to standardize or mean-center all variables, we can use `~ .` as a shortcut. Note that `std_selected` will skip categorical variables (i.e., factors or string variables in the regression model of `lm`).

```{r}
lm_stdall <- std_selected(lm_out, to_center = ~ .,
                                   to_scale  = ~ .)
summary(lm_stdall)
visreg(lm_stdall, "emotional_stability", "conscientiousness", 
            breaks = 2, overlay = TRUE)
```

# The Usual Standardized Solution

For comparison, this is the results of standardizing all variables, including the product term and the categorical variable.

```{r}
lm_beta <- lm.beta(lm_out)
summary(lm_beta)
```

# Standardize conscientiousness, emotional stability, and sleep_duration: With Nonparametric Bootstrapping Confidence Interval

It has been shown (e.g., Yuan & Chan, 2011) that the standard errors of standardized regression coefficients computed just by rescaling the variables are biased, and consequently the confidence intervals are also invalid. The function `std_selected_boot` is a version of `std_selected` that also report the confidence interval of the regression coefficients when rescaling is conducted.

We use the same example above that standardizes emotional stability, conscientiousness, and sleep duration, to illustrate this function. The argument `boot` specifies the number of nonparametric bootstrap samples. Currently, only the 95% confidence intervals will be reported.

```{r}
lm_xwy_std_ci <- std_selected_boot(lm_out, to_center = ~ emotional_stability + conscientiousness + sleep_duration,
                                           to_scale  = ~ emotional_stability + conscientiousness + sleep_duration,
                                           nboot = 2000)
summary(lm_xwy_std_ci)
```

The standardized moderation effect is -.108, and the 95% nonparametric bootstrapping confidence interval is -.207 to 0.013.

Note: As a side product, the nonparametric Bootstrapping confidence of the other coefficients are also reported. They can be used for other variables that are standardized in the same model, whether they are involved in the moderation or not.